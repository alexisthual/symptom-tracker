- name: Configure nginx and cron for symptoms-tracker
  hosts: symptoms_tracker

  vars:
    python_version: 3.7.3

  roles:
    # Install nginx
    - role: geerlingguy.nginx

  tasks:
    - name: Data folder
      file:
        path: /srv/data
        state: directory
        mode: "0755"

    - name: Mock data file
      copy:
        src: ./progress.json
        dest: /srv/data/progress.json

    - name: No default website for nginx
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Copy nginx config
      copy:
        src: nginx.conf
        dest: /etc/nginx/sites-enabled/symptoms_tracker

    - name: Restart nginx
      service:
        name: nginx
        state: restarted

    - name: Copy prod env file
      copy:
        src: ../.env.prod
        dest: /srv/.env.prod

    - name: Copy metrics script
      copy:
        src: ./script.py
        dest: /srv/script.py

    - name: Install dependencies required to setup a new version of Python
      become: yes
      apt: pkg={{ item }} state=latest
      tags: [packages]
      with_items:
        - build-essential
        - libsqlite3-dev
        - sqlite3 # for the command line client
        - libxml2-dev
        - bzip2
        - libbz2-dev
        - libssl-dev
        - redis-server
        - libpq-dev
        - python-dev

    - name: Ensure ansible-cache directory exists
      shell: mkdir /var/local/ansible-cache creates=/var/local/ansible-cache
      become: yes

    # Install Python
    - name: Download Python {{ python_version }}
      get_url: dest=/var/local/ansible-cache url=https://www.python.org/ftp/python/{{ python_version }}/Python-{{ python_version }}.tar.xz
      become: yes

    - name: Ensure Python {{ python_version }} is extracted
      shell: chdir=/var/local/ansible-cache tar xJf ./Python-{{ python_version }}.tar.xz -C /opt creates=/opt/Python-{{ python_version }}
      become: yes

    - name: Ensure Python {{ python_version }}is configured
      shell: chdir=/opt/Python-{{ python_version }} ./configure --prefix=/opt/python{{ python_version }}

    - name: "Ensure Python {{ python_version }} make'd"
      shell: chdir=/opt/Python-{{ python_version }} make

    - name: Ensure Python {{ python_version }} installed
      shell: chdir=/opt/Python-{{ python_version }} make install  # Need to add a 'creates=' flag here
      become: yes

    # Install required packages for data science
    - name: Install required packages for data science
      become: yes
      apt: pkg={{ item }} state=latest
      with_items:
        - python-scipy
        - libblas-dev
        - liblapack-dev
        - gfortran
        - libffi-dev
        - pkg-config
        - libfreetype6-dev

    - name: Install python packages
      pip: name={{ item }}
      with_items:
        - numpy
        - pandas

    - name: Add cron job
      cron:
        name: "compute symptoms-tracker progress metrics"
        minute: "20"
        job: "python3 /srv/script.py"
        state: present
